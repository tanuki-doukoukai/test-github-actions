name: Create PR staging to develop

on:
  pull_request:
    types:
      - closed
    branches:
      - staging
env:
  HEAD_BRANCH: staging
  BASE_BRANCH: develop
  IGNORE_CHECK_CI_STATUS_WORKFLOW: "Create PR staging to develop"
  NOTIFY_DISPATCH_REPOSITORIES: test-notify
  NOTIFY_EVENT_TYPE: test-notify
  NOTIFY_TYPE_CONFLICT: auto-create-pr-conflict
  NOTIFY_TYPE_FAIL_CI: auto-create-pr-fail-ci

jobs:
  with-args:
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.head.ref != 'develop'
    runs-on: ubuntu-latest
    outputs:
      head_branch: ${{ steps.set.outputs.head_branch }}
      base_branch: ${{ steps.set.outputs.base_branch }}
    steps:
      - id: set
        run: |
          echo "head_branch=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"
          echo "base_branch=$BASE_BRANCH" >> "$GITHUB_OUTPUT"

  extract-pr-info:
    needs: with-args
    runs-on: ubuntu-latest
    outputs:
      original_author: ${{ steps.set-output.outputs.original_author }}
      original_pr_number: ${{ steps.set-output.outputs.original_pr_number }}
    steps:
      - name: Determine PR info
        id: set-output
        run: |
          LOGIN="${{ github.event.pull_request.user.login }}"
          if echo "$LOGIN" | grep -q '\[bot\]$'; then
            ORIGINAL_PR_NUMBER=$(echo "${{ github.event.pull_request.body }}" | grep -oE 'original pr: #[0-9]+' | awk '{print $3}' | tr -d '#')
            ORIGINAL_AUTHOR=$(echo "${{ github.event.pull_request.body }}" | grep -oE 'original author: [a-zA-Z0-9_-]+' | awk '{print $3}')
          else
            ORIGINAL_PR_NUMBER="${{ github.event.pull_request.number }}"
            ORIGINAL_AUTHOR="${{ github.event.pull_request.user.login }}"
          fi
          echo "original_pr_number=$ORIGINAL_PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "original_author=$ORIGINAL_AUTHOR" >> "$GITHUB_OUTPUT"

  create-app-token:
    needs: with-args
    runs-on: ubuntu-latest
    steps:
      - id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.TANUKI_2_APP_ID }}
          private-key: ${{ secrets.TANUKI_2_PRIVATE_KEY }}

  check-mergeable:
    needs: create-app-token
    runs-on: ubuntu-latest
    outputs:
      mergeable: ${{ steps.merge_check.outputs.mergeable }}
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.with-args.outputs.base_branch }}
          fetch-depth: 0

      - name: Fetch head branch
        run: |
          git fetch origin ${{ needs.with-args.outputs.head_branch }}:${{ needs.with-args.outputs.head_branch }}

      - name: Check for Merge Conflicts
        id: merge_check
        run: |
          if git merge --no-commit ${{ needs.with-args.outputs.head_branch }}; then
            echo "mergeable=true" >> "$GITHUB_OUTPUT"
          else
            echo "mergeable=false" >> "$GITHUB_OUTPUT"
          fi

  create-pull-request:
    needs:
      - with-args
      - extract-pr-info
      - check-mergeable
    uses: ./.github/workflows/create-pull-request.yml
    with:
      head_branch: ${{ needs.with-args.outputs.head_branch }}
      base_branch: ${{ needs.with-args.outputs.base_branch }}
      pr_title: "${{ needs.with-args.outputs.head_branch }} -> ${{ needs.with-args.outputs.base_branch }} (#${{ needs.extract-pr-info.outputs.original_pr_number }})"
      pr_body: |
        このPRは、以下のPRの変更内容を \`${{ needs.with-args.outputs.base_branch }}\` ブランチに反映するためのものです。

        - original pr: #${{ needs.extract-pr-info.outputs.original_pr_number }}
        - original author: ${{ needs.extract-pr-info.outputs.original_author }}
    secrets:
      app_id: ${{ secrets.TANUKI_2_APP_ID }}
      app_private_key: ${{ secrets.TANUKI_2_PRIVATE_KEY }}

  check-ci-status:
    needs: 
      - create-app-token
      - create-pull-request
    runs-on: ubuntu-latest
    outputs:
      ci_passed: ${{ steps.check.outputs.ci_passed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq and gh
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Check all CI passing
        id: check
        env:
          PR_NUMBER: ${{ needs.create-pull-request.outputs.number }}
          IGNORED_WORKFLOW: ${{ env.IGNORE_CHECK_CI_STATUS_WORKFLOW }}
          APP_TOKEN: ${{ needs.create-app-token.outputs.token }}
        run: |
          bash .github/scripts/check-all-ci-success.sh

  merge-pull-request:
    needs:
      - create-app-token
      - create-pull-request
      - check-mergeable
      - check-ci-status
    if: >
      needs.check-mergeable.outputs.mergeable == 'true' && 
      needs.check-ci-status.outputs.ci_passed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Merge Pull Request
        run: |
          gh pr merge ${{ needs.create-pull-request.outputs.number }} --merge
        env:
          GITHUB_TOKEN: ${{ needs.create-app-token.outputs.token }}

  request-review:
    needs:
      - extract-pr-info
      - create-app-token
      - create-pull-request
      - check-mergeable
      - check-ci-status
    if: >
      needs.check-mergeable.outputs.mergeable == 'false' || 
      needs.check-ci-status.outputs.ci_passed == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Request Review
        run: |
          REVIEWERS_JSON="{\"reviewers\":[\"${{ needs.extract-pr-info.outputs.original_author }}\"]}"
          curl -s -X POST \
            -H "Authorization: token ${{ needs.create-app-token.outputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository_owner }}/pulls/${{ needs.create-pull-request.outputs.number }}/requested_reviewers \
            -d "$REVIEWERS_JSON"

  dispatch-notify:
    needs:
      - extract-pr-info
      - create-app-token
      - create-pull-request
      - check-mergeable
      - check-ci-status
    if: >
      needs.check-mergeable.outputs.mergeable == 'false' || 
      needs.check-ci-status.outputs.ci_passed == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Determine Notify Type
        id: notify-type
        run: |
          if [ "${{ needs.check-mergeable.outputs.mergeable }}" = "false" ]; then
            echo "notify_type=${{ env.NOTIFY_TYPE_CONFLICT }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ needs.check-ci-status.outputs.ci_passed }}" = "false" ]; then
            echo "notify_type=${{ env.NOTIFY_TYPE_FAIL_CI }}" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Failed to determine notify_type"
            exit 1
          fi

      - uses: actions/create-github-app-token@v1
        id: notify-token
        with:
          app-id: ${{ secrets.TANUKI_2_APP_ID }}
          private-key: ${{ secrets.TANUKI_2_PRIVATE_KEY }}
          repositories: ${{ env.NOTIFY_DISPATCH_REPOSITORIES }}

      - name: Dispatch Notify Workflow
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${{ steps.notify-token.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ env.NOTIFY_DISPATCH_REPOSITORIES }}/dispatches \
            -d '{
              "event_type": "${{ env.NOTIFY_EVENT_TYPE }}",
              "client_payload": {
                "notify_type": "${{ steps.notify-type.outputs.notify_type }}",
                "author": "${{ needs.extract-pr-info.outputs.original_author }}",
                "pull_request": {
                  "number": ${{ needs.create-pull-request.outputs.number }},
                  "title": "${{ needs.create-pull-request.outputs.title }}",
                  "html_url": "${{ needs.create-pull-request.outputs.html_url }}"
                }
              }
            }'
